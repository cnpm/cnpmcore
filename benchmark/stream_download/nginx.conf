server {
    listen 80;
    server_name localhost;

    # 设置根目录为 nginx 文件夹
    root /var/www/html/;
    
    # 禁用缓存以支持流式下载测试
    sendfile off;
    tcp_nopush off;
    tcp_nodelay on;
    keepalive_timeout 65;
    
    # 下载路径 - GET /download/
    location /download/ {
        # 映射到 nginx 目录中的文件
        alias /var/www/html/;
        autoindex on;
        autoindex_exact_size off;
        
        # 支持断点续传
        add_header Accept-Ranges bytes;
        
        # 设置合适的缓存头用于测试
        expires -1;
        add_header Cache-Control "no-cache, no-store, must-revalidate";
        add_header Pragma "no-cache";
        
        # 允许跨域访问（测试需要）
        add_header Access-Control-Allow-Origin *;
        add_header Access-Control-Allow-Methods "GET, OPTIONS";
        add_header Access-Control-Allow-Headers "DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range";
        
        if ($request_method = 'OPTIONS') {
            return 204;
        }
    }
    
    # 上传路径 - POST /upload/
    location /upload/ {
        # 只允许 POST 方法
        limit_except POST {
            deny all;
        }
        
        # 将上传内容重定向到 /dev/null
        client_body_in_file_only clean;
        client_body_temp_path /tmp/nginx_temp;
        client_max_body_size 0;  # 不限制上传大小
        
        # 使用 Lua 模块或直接返回 201
        return 201;
        
        # 如果需要更复杂的处理，可以使用 Lua
        # content_by_lua_block {
        #     ngx.req.read_body()
        #     local data = ngx.req.get_body_data()
        #     -- 数据已经被读取，但不做任何处理
        #     ngx.status = 201
        #     ngx.say("{\"status\":\"uploaded\",\"bytes_received\":" .. ngx.req.get_headers()["content-length"] .. "}")
        #     ngx.exit(201)
        # }
    }
    
    # 健康检查端点
    location /health {
        access_log off;
        return 200 "healthy\n";
        add_header Content-Type text/plain;
    }
    
    # 错误页面
    error_page 404 /404.html;
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}