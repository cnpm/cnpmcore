FROM node:22

# Create app directory
WORKDIR /usr/src/app

# Install app dependencies
COPY . .

RUN chmod +x .docker/build.sh && .docker/build.sh

ENV NODE_ENV=production \
  EGG_SERVER_ENV=prod \
  CNPMCORE_CONFIG_REGISTRY= \
  CNPMCORE_CONFIG_SOURCE_REGISTRY=https://registry.npmmirror.com \
  CNPMCORE_CONFIG_SOURCE_REGISTRY_IS_CNPM=true \
  CNPMCORE_DATABASE_TYPE= \
  CNPMCORE_DATABASE_NAME= \
  CNPMCORE_DATABASE_HOST= \
  CNPMCORE_DATABASE_PORT=3306 \
  CNPMCORE_DATABASE_USER= \
  CNPMCORE_DATABASE_PASSWORD= \
  CNPMCORE_REDIS_HOST= \
  CNPMCORE_REDIS_PORT=6379 \
  CNPMCORE_REDIS_PASSWORD= \
  CNPMCORE_REDIS_DB= \
  CNPMCORE_NFS_TYPE=s3 \
  CNPMCORE_NFS_S3_CLIENT_ENDPOINT= \
  CNPMCORE_NFS_S3_CLIENT_BUCKET= \
  CNPMCORE_NFS_S3_CLIENT_ID= \
  CNPMCORE_NFS_S3_CLIENT_SECRET= \
  CNPMCORE_NFS_S3_CLIENT_FORCE_PATH_STYLE=true \
  CNPMCORE_NFS_S3_CLIENT_DISABLE_URL=true \
  TZ=Asia/Shanghai

EXPOSE 7001
CMD ["npm", "run", "start:foreground"]
