# This workflow will do a clean install of node dependencies, build the source code and run tests across different versions of node
# For more information see: https://help.github.com/actions/language-and-framework-guides/using-nodejs-with-github-actions

name: Node.js CI

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  merge_group:

jobs:
  typecheck:
    runs-on: ubuntu-latest

    concurrency:
      group: typecheck-${{ github.workflow }}-#${{ github.event.pull_request.number || github.head_ref || github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout Git Source
        uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: setup utoo
        uses: utooland/setup-utoo@v1

      - name: Install Dependencies
        run: ut

      - name: Lint
        run: ut lint

      - name: Format
        run: ut fmtcheck

      - name: Typecheck
        run: ut typecheck

      - name: Build
        run: ut tsc && ut tsc:prod

  test-deployment:
    runs-on: ubuntu-latest

    concurrency:
      group: test-deployment-${{ github.workflow }}-#${{ github.event.pull_request.number || github.head_ref || github.ref }}
      cancel-in-progress: true

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_DATABASE: cnpmcore
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=5
      redis:
        # https://docs.github.com/en/actions/using-containerized-services/about-service-containers#example-mapping-redis-ports
        image: redis
        ports:
          # Opens tcp port 6379 on the host and service container
          - 6379:6379

    steps:
      - name: Checkout Git Source
        uses: actions/checkout@v6

      - name: Use Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 22

      - name: setup utoo
        uses: utooland/setup-utoo@v1

      - name: Install Dependencies
        run: ut

      - name: Test Deployment
        run: |
          ut build
          echo "Preparing database..."
          CNPMCORE_DATABASE_NAME=cnpmcore bash ./prepare-database-mysql.sh
          echo "Starting cnpmcore..."
          CNPMCORE_FORCE_LOCAL_FS=true ut start:foreground &
          sleep 5
          echo "Checking cnpmcore is ready..."

          set -Eeuo pipefail
          URL="http://127.0.0.1:7001"
          PATTERN="instance_start_time"
          TIMEOUT=60
          TMP="$(mktemp)"
          echo "ðŸ”Ž Health check $URL, expect 200 & body contains: $PATTERN"
          deadline=$((SECONDS + TIMEOUT))
          last_status=""

          while (( SECONDS < deadline )); do
            last_status="$(curl -sS -o "$TMP" -w '%{http_code}' "$URL" || true)"
            echo "last_status=$last_status"
            echo "body=$(cat $TMP)"
            if [[ "$last_status" == "200" ]] && grep -q "$PATTERN" "$TMP"; then
              echo "âœ… OK"
              rm -f "$TMP"
              npx eggctl stop
              exit 0
            fi
            sleep 1
          done

          echo "::error::âŒ Health check failed: status=$last_status"
          echo "---- Response body (last try) ----"
          cat "$TMP" || true
          rm -f "$TMP"
          exit 1

  test-postgresql-fs-nfs:
    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22, 24]
        os: [ubuntu-latest]
        # 0-based index
        shardIndex: [0, 1, 2]
        shardTotal: [3]

    name: test on postgresql (node@${{ matrix.node-version }}, shard@${{ matrix.shardIndex }}/${{ matrix.shardTotal }})
    concurrency:
      group: test-postgresql-fs-nfs-${{ github.workflow }}-#${{ github.event.pull_request.number || github.head_ref || github.ref }}-${{ matrix.node-version }}-${{ matrix.shardIndex }}/${{ matrix.shardTotal }}
      cancel-in-progress: true

    runs-on: ${{ matrix.os }}

    services:
      # https://docs.github.com/en/actions/use-cases-and-examples/using-containerized-services/creating-postgresql-service-containers
      # Label used to access the service container
      postgres:
        # Docker Hub image
        image: postgres
        # Provide the password for postgres
        env:
          POSTGRES_PASSWORD: postgres
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          # Maps tcp port 5432 on service container to the host
          - 5432:5432
      redis:
        # https://docs.github.com/en/actions/using-containerized-services/about-service-containers#example-mapping-redis-ports
        image: redis
        ports:
          # Opens tcp port 6379 on the host and service container
          - 6379:6379

    steps:
      - name: Checkout Git Source
        uses: actions/checkout@v6

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: setup utoo
        uses: utooland/setup-utoo@v1

      - name: Install Dependencies
        run: ut

      # https://github.com/elastic/elastic-github-actions/blob/master/elasticsearch/README.md
      - name: Configure sysctl limits
        run: |
          sudo swapoff -a
          sudo sysctl -w vm.swappiness=1
          sudo sysctl -w fs.file-max=262144
          sudo sysctl -w vm.max_map_count=262144

      - name: Runs Elasticsearch
        uses: elastic/elastic-github-actions/elasticsearch@master
        with:
          stack-version: 8.18.0
          security-enabled: false

      - name: Wait for Elasticsearch to be ready
        run: |
          curl -v http://localhost:9200
          while ! curl -s http://localhost:9200 | grep -q "elasticsearch"; do
            echo "Waiting for Elasticsearch to be ready..."
            sleep 1
          done

      - name: Continuous Integration
        run: ut ci:postgresql
        env:
          # The hostname used to communicate with the PostgreSQL service container
          POSTGRES_HOST: localhost
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          # The default PostgreSQL port
          POSTGRES_PORT: 5432
          CNPMCORE_CONFIG_ENABLE_ES: true
          CNPMCORE_CONFIG_ES_CLIENT_NODES: http://localhost:9200
          # https://github.com/jamiebuilds/ci-parallel-vars
          CI_NODE_INDEX: ${{ matrix.shardIndex }}
          CI_NODE_TOTAL: ${{ matrix.shardTotal }}
          # Disable vitest file parallelism in CI (uses sharding instead)
          EGG_FILE_PARALLELISM: false

      - name: Code Coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  test-mysql57-fs-nfs:
    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22, 24]
        os: [ubuntu-latest]
        # 0-based index
        shardIndex: [0, 1, 2]
        shardTotal: [3]
        enableJSONBuilder: [true, false]

    name: test on mysql (node@${{ matrix.node-version }}, shard@${{ matrix.shardIndex }}/${{ matrix.shardTotal }}, enableJSONBuilder@${{ matrix.enableJSONBuilder }})
    concurrency:
      group: test-mysql57-fs-nfs-${{ github.workflow }}-#${{ github.event.pull_request.number || github.head_ref || github.ref }}-${{ matrix.node-version }}-${{ matrix.shardIndex }}/${{ matrix.shardTotal }}-${{ matrix.enableJSONBuilder }}
      cancel-in-progress: true

    runs-on: ${{ matrix.os }}

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_DATABASE: cnpmcore_unittest
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=5
      redis:
        # https://docs.github.com/en/actions/using-containerized-services/about-service-containers#example-mapping-redis-ports
        image: redis
        ports:
          # Opens tcp port 6379 on the host and service container
          - 6379:6379

    steps:
      - name: Checkout Git Source
        uses: actions/checkout@v6

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: setup utoo
        uses: utooland/setup-utoo@v1

      - name: Install Dependencies
        run: ut

      - name: Continuous Integration
        run: ut ci
        env:
          # https://github.com/jamiebuilds/ci-parallel-vars
          CI_NODE_INDEX: ${{ matrix.shardIndex }}
          CI_NODE_TOTAL: ${{ matrix.shardTotal }}
          CNPMCORE_CONFIG_ENABLE_JSON_BUILDER: ${{ matrix.enableJSONBuilder }}
          # Disable vitest file parallelism in CI (uses sharding instead)
          EGG_FILE_PARALLELISM: false

      - name: Code Coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  test-mysql57-s3-nfs:
    if: ${{ github.ref_name == 'master' }}
    strategy:
      fail-fast: false
      matrix:
        node-version: [20, 22, 24]
        os: [ubuntu-latest]

    concurrency:
      group: test-mysql57-s3-nfs-${{ github.workflow }}-#${{ github.event.pull_request.number || github.head_ref || github.ref }}-${{ matrix.node-version }}
      cancel-in-progress: true

    runs-on: ${{ matrix.os }}

    services:
      mysql:
        image: mysql:5.7
        env:
          MYSQL_ALLOW_EMPTY_PASSWORD: true
          MYSQL_DATABASE: cnpmcore_unittest
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=5

      redis:
        image: redis
        ports:
          - 6379:6379

    steps:
      - name: Checkout Git Source
        uses: actions/checkout@v6

      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v6
        with:
          node-version: ${{ matrix.node-version }}

      - name: setup utoo
        uses: utooland/setup-utoo@v1

      - name: Install Dependencies
        run: ut

      - name: Continuous Integration
        run: ut ci "test/cli/npm/install.test.ts"
        env:
          # Disable vitest file parallelism in CI (uses sharding instead)
          EGG_FILE_PARALLELISM: false
          CNPMCORE_NFS_TYPE: s3
          CNPMCORE_NFS_REMOVE_BEFORE_UPLOAD: true
          CNPMCORE_NFS_S3_CLIENT_BUCKET: cnpmcore-unittest-github-nodejs-${{ matrix.node-version }}
          CNPMCORE_NFS_S3_CLIENT_ENDPOINT: ${{ secrets.CNPMCORE_NFS_S3_ENDPOINT }}
          CNPMCORE_NFS_S3_CLIENT_ID: ${{ secrets.CNPMCORE_NFS_S3_ID }}
          CNPMCORE_NFS_S3_CLIENT_SECRET: ${{ secrets.CNPMCORE_NFS_S3_SECRET }}
          CNPMCORE_NFS_S3_CLIENT_FORCE_PATH_STYLE: true
          # CNPMCORE_NFS_S3_CLIENT_DISABLE_URL: true

      - name: Code Coverage
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}

  done:
    runs-on: ubuntu-latest
    needs:
      - test-postgresql-fs-nfs
      - test-mysql57-fs-nfs
      - typecheck
    steps:
      - run: exit 1
        if: ${{ always() && (contains(needs.*.result, 'failure') || contains(needs.*.result, 'cancelled')) }}
